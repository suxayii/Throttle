cat > /root/net-tune-menu.sh <<'EOF'
#!/usr/bin/env bash
set -euo pipefail

SYSCTL_FILE="/etc/sysctl.d/99-net-tune-menu.conf"
BACKUP_DIR="/root/sysctl-backups"
mkdir -p "$BACKUP_DIR"

CURRENT_PROFILE=""

# ---------- åŸºç¡€å‡½æ•° ----------
ts() { date +%F_%H%M%S; }

backup_now() {
  local t
  t="$(ts)"
  sysctl -a 2>/dev/null > "${BACKUP_DIR}/sysctl-all-${t}.bak" || true
  [[ -f "$SYSCTL_FILE" ]] && cp -a "$SYSCTL_FILE" "${BACKUP_DIR}/99-net-tune-menu.conf.${t}.bak"
}

reload_sysctl() {
  sysctl --system >/dev/null
}

print_key_params() {
  echo
  echo "=== å½“å‰å…³é”®å‚æ•° ==="
  sysctl \
    net.core.netdev_max_backlog \
    net.core.somaxconn \
    net.ipv4.tcp_max_syn_backlog \
    net.core.rmem_default \
    net.core.wmem_default \
    net.core.rmem_max \
    net.core.wmem_max \
    net.ipv4.tcp_rmem \
    net.ipv4.tcp_wmem \
    net.ipv4.udp_rmem_min \
    net.ipv4.udp_wmem_min \
    net.ipv4.tcp_fastopen \
    net.ipv4.tcp_mtu_probing \
    net.ipv4.tcp_fin_timeout \
    net.ipv4.tcp_tw_reuse \
    net.ipv4.ip_local_port_range \
    net.ipv4.tcp_syncookies \
    net.core.default_qdisc \
    net.ipv4.tcp_congestion_control \
    net.ipv4.tcp_slow_start_after_idle 2>/dev/null || true
  echo
}

show_current_config_file() {
  echo "=== å½“å‰é…ç½®æ–‡ä»¶: $SYSCTL_FILE ==="
  if [[ -f "$SYSCTL_FILE" ]]; then
    cat "$SYSCTL_FILE"
  else
    echo "æœªæ‰¾åˆ°é…ç½®æ–‡ä»¶ï¼ˆå°šæœªåº”ç”¨èœå•é…ç½®ï¼‰"
  fi
  echo
}

# ---------- å…¬å…±åŸºç¡€é¡¹ ----------
common_base() {
  cat <<'CONF'
# ===== Generated by net-tune-menu.sh =====
# é€šç”¨åŸºç¡€é¡¹
net.ipv4.tcp_fastopen = 3
net.ipv4.tcp_mtu_probing = 1
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_fin_timeout = 20
net.ipv4.ip_local_port_range = 10240 65535
net.core.default_qdisc = fq
net.ipv4.tcp_congestion_control = bbr
net.ipv4.tcp_slow_start_after_idle = 0
CONF
}

# ---------- é…ç½®æ¨¡æ¿ ----------
profile_balanced() {
  cat <<'CONF'
# ---- profile: balanced ----
net.core.netdev_max_backlog = 65536
net.core.somaxconn = 16384
net.ipv4.tcp_max_syn_backlog = 65536
net.core.rmem_default = 262144
net.core.wmem_default = 262144
net.core.rmem_max = 67108864
net.core.wmem_max = 67108864
net.ipv4.tcp_rmem = 4096 87380 33554432
net.ipv4.tcp_wmem = 4096 65536 33554432
net.ipv4.udp_rmem_min = 16384
net.ipv4.udp_wmem_min = 16384
CONF
}

profile_aggressive() {
  cat <<'CONF'
# ---- profile: aggressive ----
net.core.netdev_max_backlog = 250000
net.core.somaxconn = 65535
net.ipv4.tcp_max_syn_backlog = 262144
net.core.rmem_default = 262144
net.core.wmem_default = 262144
net.core.rmem_max = 134217728
net.core.wmem_max = 134217728
net.ipv4.tcp_rmem = 4096 87380 67108864
net.ipv4.tcp_wmem = 4096 65536 67108864
net.ipv4.udp_rmem_min = 16384
net.ipv4.udp_wmem_min = 16384
net.ipv4.tcp_fin_timeout = 15
CONF
}

profile_aggressive_safe() {
  cat <<'CONF'
# ---- profile: aggressive_safe ----
net.core.netdev_max_backlog = 131072
net.core.somaxconn = 32768
net.ipv4.tcp_max_syn_backlog = 131072
net.core.rmem_default = 262144
net.core.wmem_default = 262144
net.core.rmem_max = 134217728
net.core.wmem_max = 134217728
net.ipv4.tcp_rmem = 4096 87380 67108864
net.ipv4.tcp_wmem = 4096 65536 67108864
net.ipv4.udp_rmem_min = 16384
net.ipv4.udp_wmem_min = 16384
CONF
}

profile_xray_hy2() {
  cat <<'CONF'
# ---- profile: xray_hy2 ----
# é’ˆå¯¹ TCP + UDP æ··åˆä»£ç†
net.core.netdev_max_backlog = 131072
net.core.somaxconn = 32768
net.ipv4.tcp_max_syn_backlog = 131072
net.core.rmem_default = 262144
net.core.wmem_default = 262144
net.core.rmem_max = 134217728
net.core.wmem_max = 134217728
net.ipv4.tcp_rmem = 4096 87380 67108864
net.ipv4.tcp_wmem = 4096 65536 67108864
net.ipv4.udp_rmem_min = 16384
net.ipv4.udp_wmem_min = 16384
CONF
}

profile_low_1c1g() {
  cat <<'CONF'
# ---- profile: low_1c1g ----
net.core.netdev_max_backlog = 8192
net.core.somaxconn = 2048
net.ipv4.tcp_max_syn_backlog = 8192
net.core.rmem_default = 131072
net.core.wmem_default = 131072
net.core.rmem_max = 16777216
net.core.wmem_max = 16777216
net.ipv4.tcp_rmem = 4096 87380 8388608
net.ipv4.tcp_wmem = 4096 65536 8388608
net.ipv4.udp_rmem_min = 8192
net.ipv4.udp_wmem_min = 8192
CONF
}

profile_low_2c2g() {
  cat <<'CONF'
# ---- profile: low_2c2g ----
net.core.netdev_max_backlog = 16384
net.core.somaxconn = 4096
net.ipv4.tcp_max_syn_backlog = 16384
net.core.rmem_default = 262144
net.core.wmem_default = 262144
net.core.rmem_max = 33554432
net.core.wmem_max = 33554432
net.ipv4.tcp_rmem = 4096 87380 16777216
net.ipv4.tcp_wmem = 4096 65536 16777216
net.ipv4.udp_rmem_min = 8192
net.ipv4.udp_wmem_min = 8192
CONF
}

profile_bw_1g() {
  cat <<'CONF'
# ---- profile: bw_1g ----
net.core.netdev_max_backlog = 32768
net.core.somaxconn = 16384
net.ipv4.tcp_max_syn_backlog = 65536
net.core.rmem_default = 262144
net.core.wmem_default = 262144
net.core.rmem_max = 67108864
net.core.wmem_max = 67108864
net.ipv4.tcp_rmem = 4096 87380 33554432
net.ipv4.tcp_wmem = 4096 65536 33554432
net.ipv4.udp_rmem_min = 16384
net.ipv4.udp_wmem_min = 16384
CONF
}

profile_bw_10g() {
  cat <<'CONF'
# ---- profile: bw_10g ----
net.core.netdev_max_backlog = 131072
net.core.somaxconn = 32768
net.ipv4.tcp_max_syn_backlog = 131072
net.core.rmem_default = 262144
net.core.wmem_default = 262144
net.core.rmem_max = 134217728
net.core.wmem_max = 134217728
net.ipv4.tcp_rmem = 4096 87380 67108864
net.ipv4.tcp_wmem = 4096 65536 67108864
net.ipv4.udp_rmem_min = 16384
net.ipv4.udp_wmem_min = 16384
CONF
}

emit_profile() {
  case "$1" in
    balanced)        profile_balanced ;;
    aggressive)      profile_aggressive ;;
    aggressive_safe) profile_aggressive_safe ;;
    xray_hy2)        profile_xray_hy2 ;;
    low_1c1g)        profile_low_1c1g ;;
    low_2c2g)        profile_low_2c2g ;;
    bw_1g)           profile_bw_1g ;;
    bw_10g)          profile_bw_10g ;;
    *)
      echo "æœªçŸ¥ profile: $1" >&2
      return 1
      ;;
  esac
}

apply_profile() {
  local p="$1"
  backup_now
  {
    common_base
    emit_profile "$p"
  } > "$SYSCTL_FILE"

  reload_sysctl
  CURRENT_PROFILE="$p"
  echo
  echo "âœ… å·²åº”ç”¨é…ç½®: $p"
  echo "ğŸ“„ é…ç½®æ–‡ä»¶: $SYSCTL_FILE"
  echo "ğŸ’¾ å¤‡ä»½ç›®å½•: $BACKUP_DIR"
  print_key_params
}

preview_profile() {
  local p="$1"
  echo "===== é¢„è§ˆ profile: $p ====="
  common_base
  emit_profile "$p"
  echo
}

rollback_config() {
  if [[ -f "$SYSCTL_FILE" ]]; then
    rm -f "$SYSCTL_FILE"
    reload_sysctl
    echo "âœ… å·²å›æ»šï¼ˆåˆ é™¤ $SYSCTL_FILE å¹¶é‡è½½ sysctlï¼‰"
  else
    echo "â„¹ï¸ æœªå‘ç° $SYSCTL_FILEï¼Œæ— éœ€å›æ»š"
  fi
}

watch_metrics() {
  echo "è¿›å…¥å®æ—¶ç›‘æ§ï¼ˆæ¯2ç§’åˆ·æ–°ï¼‰ï¼ŒCtrl+C è¿”å›èœå•..."
  sleep 1
  while true; do
    clear
    echo "===== $(date '+%F %T') ====="
    echo "[softnet_stat ä¸¢åŒ…åˆ—(ç¬¬2åˆ—) å‰8è¡Œ]"
    awk '{print NR ": " $2}' /proc/net/softnet_stat | head -n 8
    echo
    echo "[ss -s]"
    ss -s || true
    echo
    echo "[netstatå…³é”®ç»Ÿè®¡]"
    netstat -s 2>/dev/null | grep -Ei 'listen|overflow|drop|retrans|fail|prune' | head -n 40 || true
    echo
    echo "[å†…å­˜]"
    free -h || true
    sleep 2
  done
}

auto_recommend() {
  local mem_mb cpu nic speed
  mem_mb=$(awk '/MemTotal/ {print int($2/1024)}' /proc/meminfo)
  cpu=$(nproc)
  nic=$(ip route show default 2>/dev/null | awk '/default/ {print $5; exit}')
  speed=0
  if [[ -n "${nic:-}" && -r "/sys/class/net/$nic/speed" ]]; then
    speed=$(cat "/sys/class/net/$nic/speed" 2>/dev/null || echo 0)
  fi

  local rec="balanced"
  if (( cpu <= 1 || mem_mb <= 1200 )); then
    rec="low_1c1g"
  elif (( cpu <= 2 || mem_mb <= 2400 )); then
    rec="low_2c2g"
  elif (( speed >= 10000 )); then
    rec="bw_10g"
  elif (( speed >= 1000 )); then
    rec="bw_1g"
  fi

  echo
  echo "=== è‡ªåŠ¨è¯†åˆ«ç»“æœ ==="
  echo "CPUæ ¸æ•°: $cpu"
  echo "å†…å­˜MB: $mem_mb"
  echo "é»˜è®¤ç½‘å¡: ${nic:-unknown}"
  echo "ç½‘å¡é€Ÿç‡(Mbps): ${speed:-unknown}"
  echo "æ¨èé…ç½®: $rec"
  echo
  read -rp "æ˜¯å¦ç«‹å³åº”ç”¨æ¨èé…ç½®? [y/N]: " yn
  case "${yn:-N}" in
    y|Y) apply_profile "$rec" ;;
    *) echo "å·²å–æ¶ˆåº”ç”¨ã€‚" ;;
  esac
}

choose_profile_menu() {
  while true; do
    echo
    echo "è¯·é€‰æ‹©è¦åº”ç”¨çš„é…ç½®ï¼š"
    echo " 1) balanced        (å¹³è¡¡ç‰ˆ)"
    echo " 2) aggressive      (æ¿€è¿›ç‰ˆ)"
    echo " 3) aggressive_safe (æ¿€è¿›ä½†æ›´ç¨³)"
    echo " 4) xray_hy2        (Xray/Hy2 ä¸“é¡¹)"
    echo " 5) low_1c1g        (ä½å†…å­˜ä¿å®ˆ 1C/1G)"
    echo " 6) low_2c2g        (ä½å†…å­˜ä¿å®ˆ 2C/2G)"
    echo " 7) bw_1g           (é«˜å¸¦å®½ 1Gå£)"
    echo " 8) bw_10g          (é«˜å¸¦å®½ 10Gå£)"
    echo " 9) è¿”å›ä¸Šçº§èœå•"
    read -rp "è¾“å…¥é€‰é¡¹ [1-9]: " c

    case "$c" in
      1) apply_profile balanced; break ;;
      2) apply_profile aggressive; break ;;
      3) apply_profile aggressive_safe; break ;;
      4) apply_profile xray_hy2; break ;;
      5) apply_profile low_1c1g; break ;;
      6) apply_profile low_2c2g; break ;;
      7) apply_profile bw_1g; break ;;
      8) apply_profile bw_10g; break ;;
      9) break ;;
      *) echo "æ— æ•ˆè¾“å…¥ï¼Œè¯·é‡è¯•ã€‚" ;;
    esac
  done
}

preview_menu() {
  while true; do
    echo
    echo "è¯·é€‰æ‹©è¦é¢„è§ˆçš„é…ç½®ï¼š"
    echo " 1) balanced"
    echo " 2) aggressive"
    echo " 3) aggressive_safe"
    echo " 4) xray_hy2"
    echo " 5) low_1c1g"
    echo " 6) low_2c2g"
    echo " 7) bw_1g"
    echo " 8) bw_10g"
    echo " 9) è¿”å›ä¸Šçº§èœå•"
    read -rp "è¾“å…¥é€‰é¡¹ [1-9]: " c

    case "$c" in
      1) preview_profile balanced ;;
      2) preview_profile aggressive ;;
      3) preview_profile aggressive_safe ;;
      4) preview_profile xray_hy2 ;;
      5) preview_profile low_1c1g ;;
      6) preview_profile low_2c2g ;;
      7) preview_profile bw_1g ;;
      8) preview_profile bw_10g ;;
      9) break ;;
      *) echo "æ— æ•ˆè¾“å…¥ï¼Œè¯·é‡è¯•ã€‚" ;;
    esac
  done
}

main_menu() {
  while true; do
    echo
    echo "=================================================="
    echo " Linux ç½‘ç»œä¼˜åŒ–äº¤äº’èœå• (Xray/Hy2/é€šç”¨)"
    echo " é…ç½®æ–‡ä»¶: $SYSCTL_FILE"
    echo " å½“å‰ä¼šè¯å·²åº”ç”¨: ${CURRENT_PROFILE:-æ— }"
    echo "=================================================="
    echo " 1) åº”ç”¨é…ç½®ï¼ˆé€‰æ‹©ç‰ˆæœ¬ï¼‰"
    echo " 2) é¢„è§ˆé…ç½®ï¼ˆä¸åº”ç”¨ï¼‰"
    echo " 3) è‡ªåŠ¨è¯†åˆ«å¹¶æ¨è"
    echo " 4) æŸ¥çœ‹å½“å‰çŠ¶æ€"
    echo " 5) æŸ¥çœ‹å½“å‰é…ç½®æ–‡ä»¶"
    echo " 6) å®æ—¶ç›‘æ§ï¼ˆwatchï¼‰"
    echo " 7) ä¸€é”®å›æ»š"
    echo " 0) é€€å‡º"
    read -rp "è¯·è¾“å…¥é€‰é¡¹ [0-7]: " choice

    case "$choice" in
      1) choose_profile_menu ;;
      2) preview_menu ;;
      3) auto_recommend ;;
      4) print_key_params ;;
      5) show_current_config_file ;;
      6) watch_metrics ;;
      7) rollback_config ;;
      0) echo "å·²é€€å‡ºã€‚"; exit 0 ;;
      *) echo "æ— æ•ˆè¾“å…¥ï¼Œè¯·é‡è¯•ã€‚" ;;
    esac
  done
}

# root æ£€æŸ¥
if [[ "${EUID:-$(id -u)}" -ne 0 ]]; then
  echo "è¯·ç”¨ root è¿è¡Œï¼šsudo bash /root/net-tune-menu.sh"
  exit 1
fi

main_menu
EOF

chmod +x /root/net-tune-menu.sh
bash /root/net-tune-menu.sh
