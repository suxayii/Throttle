cat > /root/net-tune-pro-v3-zh.sh <<'EOF'
#!/usr/bin/env bash
set -euo pipefail

# ===================== åŸºç¡€è·¯å¾„ =====================
ACTIVE_FILE="/etc/sysctl.d/99-net-tune-pro-v3.conf"            # ç½‘ç»œæ–¹æ¡ˆæ‰˜ç®¡æ–‡ä»¶
BBR_SYSCTL_FILE="/etc/sysctl.d/99-joeyblog.conf"               # BBR/QDISCæ‰˜ç®¡æ–‡ä»¶
MODULES_CONF="/etc/modules-load.d/joeyblog-qdisc.conf"         # qdiscæ¨¡å—è‡ªåŠ¨åŠ è½½
BACKUP_DIR="/root/sysctl-backups-v3"
PERM_DIR="/root/sysctl-permanent-baseline-v3"
LAST_APPLY_DIR="${BACKUP_DIR}/last_apply"
HISTORY_DIR="${BACKUP_DIR}/history"
LOG_FILE="/var/log/net-tune-pro-v3.log"

mkdir -p "$BACKUP_DIR" "$PERM_DIR" "$LAST_APPLY_DIR" "$HISTORY_DIR"
touch "$LOG_FILE"

CURRENT_PROFILE=""
ARCH="$(uname -m)"

# ç‰ˆæœ¬å·
VERSION="3.1.0"

# ===================== é¢œè‰² =====================
RED='\033[31m'; GREEN='\033[32m'; YELLOW='\033[33m'; BLUE='\033[36m'; BOLD='\033[1m'; NC='\033[0m'
ok(){ echo -e "${GREEN}âœ… $*${NC}"; }
warn(){ echo -e "${YELLOW}âš ï¸  $*${NC}"; }
err(){ echo -e "${RED}âŒ $*${NC}"; }
info(){ echo -e "${BLUE}â„¹ï¸  $*${NC}"; }
line(){ echo "------------------------------------------------------------"; }

log(){ echo "[$(date '+%F %T')] $*" >> "$LOG_FILE"; }
pause(){ read -rp "æŒ‰ Enter ç»§ç»­..."; }
ts(){ date +%F_%H%M%S; }
cmd_exists(){ command -v "$1" >/dev/null 2>&1; }

need_root(){
  if [[ "${EUID:-$(id -u)}" -ne 0 ]]; then
    err "è¯·ä½¿ç”¨ root è¿è¡Œï¼šsudo bash /root/net-tune-pro-v3-zh.sh"
    exit 1
  fi
}

is_debian_like(){
  cmd_exists apt-get
}

# ===================== ä¾èµ–æ£€æŸ¥ï¼ˆå°½é‡ä¸å¼ºè£…ï¼‰ =====================
check_base_deps(){
  local miss=0
  for c in sysctl awk grep sed ip ss find mktemp install; do
    if ! cmd_exists "$c"; then
      err "ç¼ºå°‘åŸºç¡€ä¾èµ–ï¼š$c"
      miss=1
    fi
  done
  if (( miss == 1 )); then
    err "åŸºç¡€ä¾èµ–ä¸å®Œæ•´ï¼Œè¯·å…ˆå®‰è£…åé‡è¯•ã€‚"
    return 1
  fi
  return 0
}

ensure_bbr_deps_debian(){
  local required=("curl" "wget" "dpkg" "awk" "sed" "sysctl" "jq")
  local need_install=()
  for c in "${required[@]}"; do
    cmd_exists "$c" || need_install+=("$c")
  done

  if [[ ${#need_install[@]} -gt 0 ]]; then
    info "æ£€æµ‹åˆ°ç¼ºå°‘ä¾èµ–ï¼š${need_install[*]}"
    apt-get update -y >/dev/null 2>&1 || true
    apt-get install -y "${need_install[@]}" >/dev/null 2>&1 || {
      err "ä¾èµ–å®‰è£…å¤±è´¥ï¼š${need_install[*]}"
      return 1
    }
    ok "ä¾èµ–å®‰è£…å®Œæˆ"
  fi
}

# ===================== ç½‘ç»œä¼˜åŒ–æ–¹æ¡ˆæ¨¡æ¿ =====================
common_base() {
cat <<'CONF'
# ===== Generated by net-tune-pro-v3-zh.sh =====
# é€šç”¨åŸºç¡€é¡¹
net.ipv4.tcp_fastopen = 3
net.ipv4.tcp_mtu_probing = 1
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_fin_timeout = 20
net.ipv4.ip_local_port_range = 10240 65535
net.core.default_qdisc = fq
net.ipv4.tcp_congestion_control = bbr
net.ipv4.tcp_slow_start_after_idle = 0
CONF
}
profile_balanced(){ cat <<'CONF'
# ---- æ–¹æ¡ˆï¼šå¹³è¡¡ç‰ˆ ----
net.core.netdev_max_backlog = 65536
net.core.somaxconn = 16384
net.ipv4.tcp_max_syn_backlog = 65536
net.core.rmem_default = 262144
net.core.wmem_default = 262144
net.core.rmem_max = 67108864
net.core.wmem_max = 67108864
net.ipv4.tcp_rmem = 4096 87380 33554432
net.ipv4.tcp_wmem = 4096 65536 33554432
net.ipv4.udp_rmem_min = 16384
net.ipv4.udp_wmem_min = 16384
CONF
}
profile_aggressive(){ cat <<'CONF'
# ---- æ–¹æ¡ˆï¼šæ¿€è¿›ç‰ˆ ----
net.core.netdev_max_backlog = 250000
net.core.somaxconn = 65535
net.ipv4.tcp_max_syn_backlog = 262144
net.core.rmem_default = 262144
net.core.wmem_default = 262144
net.core.rmem_max = 134217728
net.core.wmem_max = 134217728
net.ipv4.tcp_rmem = 4096 87380 67108864
net.ipv4.tcp_wmem = 4096 65536 67108864
net.ipv4.udp_rmem_min = 16384
net.ipv4.udp_wmem_min = 16384
net.ipv4.tcp_fin_timeout = 15
CONF
}
profile_aggressive_safe(){ cat <<'CONF'
# ---- æ–¹æ¡ˆï¼šæ¿€è¿›ç¨³å¦¥ç‰ˆ ----
net.core.netdev_max_backlog = 131072
net.core.somaxconn = 32768
net.ipv4.tcp_max_syn_backlog = 131072
net.core.rmem_default = 262144
net.core.wmem_default = 262144
net.core.rmem_max = 134217728
net.core.wmem_max = 134217728
net.ipv4.tcp_rmem = 4096 87380 67108864
net.ipv4.tcp_wmem = 4096 65536 67108864
net.ipv4.udp_rmem_min = 16384
net.ipv4.udp_wmem_min = 16384
CONF
}
profile_udp_quic(){ cat <<'CONF'
# ---- æ–¹æ¡ˆï¼šUDP ä¸“é¡¹ï¼ˆQUIC/UDP ä¼˜åŒ–ï¼‰ ----
net.core.netdev_max_backlog = 131072
net.core.somaxconn = 32768
net.ipv4.tcp_max_syn_backlog = 131072
net.core.rmem_default = 524288
net.core.wmem_default = 524288
net.core.rmem_max = 134217728
net.core.wmem_max = 134217728
net.ipv4.tcp_rmem = 4096 87380 67108864
net.ipv4.tcp_wmem = 4096 65536 67108864
net.ipv4.udp_rmem_min = 65536
net.ipv4.udp_wmem_min = 65536
net.core.netdev_budget = 600
net.core.netdev_budget_usecs = 20000
net.ipv4.udp_mem = 394110 524880 789222
net.ipv4.tcp_notsent_lowat = 16384
CONF
}
profile_low_1c1g(){ cat <<'CONF'
# ---- æ–¹æ¡ˆï¼šä½å†…å­˜ä¿å®ˆç‰ˆ 1C/1G ----
net.core.netdev_max_backlog = 8192
net.core.somaxconn = 2048
net.ipv4.tcp_max_syn_backlog = 8192
net.core.rmem_default = 131072
net.core.wmem_default = 131072
net.core.rmem_max = 16777216
net.core.wmem_max = 16777216
net.ipv4.tcp_rmem = 4096 87380 8388608
net.ipv4.tcp_wmem = 4096 65536 8388608
net.ipv4.udp_rmem_min = 8192
net.ipv4.udp_wmem_min = 8192
CONF
}
profile_low_2c2g(){ cat <<'CONF'
# ---- æ–¹æ¡ˆï¼šä½å†…å­˜ä¿å®ˆç‰ˆ 2C/2G ----
net.core.netdev_max_backlog = 16384
net.core.somaxconn = 4096
net.ipv4.tcp_max_syn_backlog = 16384
net.core.rmem_default = 262144
net.core.wmem_default = 262144
net.core.rmem_max = 33554432
net.core.wmem_max = 33554432
net.ipv4.tcp_rmem = 4096 87380 16777216
net.ipv4.tcp_wmem = 4096 65536 16777216
net.ipv4.udp_rmem_min = 8192
net.ipv4.udp_wmem_min = 8192
CONF
}
profile_bw_1g(){ cat <<'CONF'
# ---- æ–¹æ¡ˆï¼šé«˜å¸¦å®½ç‰ˆ 1Gå£ ----
net.core.netdev_max_backlog = 32768
net.core.somaxconn = 16384
net.ipv4.tcp_max_syn_backlog = 65536
net.core.rmem_default = 262144
net.core.wmem_default = 262144
net.core.rmem_max = 67108864
net.core.wmem_max = 67108864
net.ipv4.tcp_rmem = 4096 87380 33554432
net.ipv4.tcp_wmem = 4096 65536 33554432
net.ipv4.udp_rmem_min = 16384
net.ipv4.udp_wmem_min = 16384
CONF
}
profile_bw_10g(){ cat <<'CONF'
# ---- æ–¹æ¡ˆï¼šé«˜å¸¦å®½ç‰ˆ 10Gå£ ----
net.core.netdev_max_backlog = 131072
net.core.somaxconn = 32768
net.ipv4.tcp_max_syn_backlog = 131072
net.core.rmem_default = 262144
net.core.wmem_default = 262144
net.core.rmem_max = 134217728
net.core.wmem_max = 134217728
net.ipv4.tcp_rmem = 4096 87380 67108864
net.ipv4.tcp_wmem = 4096 65536 67108864
net.ipv4.udp_rmem_min = 16384
net.ipv4.udp_wmem_min = 16384
CONF
}
profile_vps_max(){ cat <<'CONF'
# ---- æ–¹æ¡ˆï¼šVPS æè‡´å¸¦å®½ç‰ˆï¼ˆè™šæ‹Ÿç½‘å¡ï¼‰ ----
# é’ˆå¯¹è™šæ‹ŸåŒ–ç¯å¢ƒä¼˜åŒ–ï¼Œæœ€å¤§åŒ–å¸¦å®½åˆ©ç”¨ç‡
net.core.netdev_max_backlog = 250000
net.core.somaxconn = 65535
net.ipv4.tcp_max_syn_backlog = 262144
net.core.rmem_default = 524288
net.core.wmem_default = 524288
net.core.rmem_max = 268435456
net.core.wmem_max = 268435456
net.ipv4.tcp_rmem = 4096 131072 134217728
net.ipv4.tcp_wmem = 4096 131072 134217728
net.ipv4.udp_rmem_min = 16384
net.ipv4.udp_wmem_min = 16384
net.ipv4.tcp_notsent_lowat = 16384
net.ipv4.tcp_window_scaling = 1
net.ipv4.tcp_timestamps = 1
net.ipv4.tcp_sack = 1
CONF
}

profile_streaming(){ cat <<'CONF'
# ---- æ–¹æ¡ˆï¼šæµåª’ä½“ä»£ç†ç‰ˆï¼ˆVLESS/Reality TCP ä¼˜åŒ–ï¼‰ ----
# é’ˆå¯¹ Netflix/YouTube/TikTok ç­‰è§†é¢‘æµåª’ä½“åœºæ™¯
# åŸºäºæ¿€è¿›ç¨³å¦¥ç‰ˆç¼“å†²åŒº + æµåª’ä½“ä¸“ç”¨ TCP é€‰é¡¹
net.core.netdev_max_backlog = 131072
net.core.somaxconn = 32768
net.ipv4.tcp_max_syn_backlog = 131072
net.core.rmem_default = 262144
net.core.wmem_default = 262144
net.core.rmem_max = 134217728
net.core.wmem_max = 134217728
net.ipv4.tcp_rmem = 4096 87380 67108864
net.ipv4.tcp_wmem = 4096 65536 67108864
net.ipv4.udp_rmem_min = 16384
net.ipv4.udp_wmem_min = 16384
net.ipv4.tcp_notsent_lowat = 16384
net.ipv4.tcp_window_scaling = 1
net.ipv4.tcp_timestamps = 1
net.ipv4.tcp_sack = 1
net.ipv4.tcp_thin_linear_timeouts = 1
CONF
}

emit_profile(){
  case "$1" in
    balanced) profile_balanced ;;
    aggressive) profile_aggressive ;;
    aggressive_safe) profile_aggressive_safe ;;
    udp_quic) profile_udp_quic ;;
    streaming) profile_streaming ;;
    low_1c1g) profile_low_1c1g ;;
    low_2c2g) profile_low_2c2g ;;
    bw_1g) profile_bw_1g ;;
    bw_10g) profile_bw_10g ;;
    vps_max) profile_vps_max ;;
    *) return 1 ;;
  esac
}

# ===================== æ ¡éªŒ/æ£€æŸ¥ =====================
extract_max_from_triplet(){ awk '{print $3}' <<<"$1"; }
escape_regex() { sed -e 's/[][(){}.^$*+?|\/]/\\&/g' <<<"$1"; }

validate_profile_semantics(){
  local tmp="$1"
  local rmem_max wmem_max tcp_rmem tcp_wmem tr tw
  rmem_max="$(awk -F= '/^[[:space:]]*net\.core\.rmem_max[[:space:]]*=/{gsub(/[ \t]/,"",$2);print $2}' "$tmp" | tail -n1)"
  wmem_max="$(awk -F= '/^[[:space:]]*net\.core\.wmem_max[[:space:]]*=/{gsub(/[ \t]/,"",$2);print $2}' "$tmp" | tail -n1)"
  tcp_rmem="$(awk -F= '/^[[:space:]]*net\.ipv4\.tcp_rmem[[:space:]]*=/{sub(/^[ \t]+/,"",$2);print $2}' "$tmp" | tail -n1)"
  tcp_wmem="$(awk -F= '/^[[:space:]]*net\.ipv4\.tcp_wmem[[:space:]]*=/{sub(/^[ \t]+/,"",$2);print $2}' "$tmp" | tail -n1)"
  tr="$(extract_max_from_triplet "$tcp_rmem")"
  tw="$(extract_max_from_triplet "$tcp_wmem")"
  [[ -n "$rmem_max" && -n "$tr" ]] && (( rmem_max < tr )) && { err "å‚æ•°æ ¡éªŒå¤±è´¥ï¼šrmem_max < tcp_rmem æœ€å¤§å€¼"; return 1; }
  [[ -n "$wmem_max" && -n "$tw" ]] && (( wmem_max < tw )) && { err "å‚æ•°æ ¡éªŒå¤±è´¥ï¼šwmem_max < tcp_wmem æœ€å¤§å€¼"; return 1; }
  return 0
}

precheck(){
  echo
  echo -e "${BOLD}ã€é¢„æ£€æŸ¥é˜¶æ®µã€‘${NC}"
  line
  check_base_deps || return 1

  # ===== å†…æ ¸ä¸ BBR çŠ¶æ€ =====
  local kernel_ver bbr_available current_cc current_qdisc bbr_version
  kernel_ver="$(uname -r || true)"
  info "å†…æ ¸ç‰ˆæœ¬ï¼š$kernel_ver"
  
  # æ£€æŸ¥ BBR å¯ç”¨æ€§
  bbr_available="no"
  if [[ -r /proc/sys/net/ipv4/tcp_available_congestion_control ]]; then
    local available_cc
    available_cc="$(cat /proc/sys/net/ipv4/tcp_available_congestion_control 2>/dev/null || true)"
    info "å¯ç”¨æ‹¥å¡æ§åˆ¶ï¼š$available_cc"
    if echo "$available_cc" | grep -qw bbr; then
      bbr_available="yes"
      ok "å†…æ ¸æ”¯æŒ BBR"
    else
      warn "å†…æ ¸æœªæŠ¥å‘Š BBR æ”¯æŒ"
    fi
  fi
  
  # å½“å‰æ‹¥å¡æ§åˆ¶çŠ¶æ€
  current_cc="$(sysctl -n net.ipv4.tcp_congestion_control 2>/dev/null || echo unknown)"
  current_qdisc="$(sysctl -n net.core.default_qdisc 2>/dev/null || echo unknown)"
  info "å½“å‰æ‹¥å¡æ§åˆ¶ï¼š$current_cc"
  info "å½“å‰é˜Ÿåˆ—ç®—æ³•ï¼š$current_qdisc"
  
  # BBR æ¨¡å—ç‰ˆæœ¬æ£€æµ‹
  if [[ "$current_cc" == "bbr" ]]; then
    ok "BBR å·²å¯ç”¨"
    bbr_version="$(modinfo tcp_bbr 2>/dev/null | awk '/^version:/ {print $2}' || true)"
    if [[ -n "$bbr_version" ]]; then
      info "BBR æ¨¡å—ç‰ˆæœ¬ï¼š$bbr_version"
    fi
  else
    warn "BBR æœªå¯ç”¨ï¼ˆå½“å‰ï¼š$current_ccï¼‰"
  fi

  # ===== è™šæ‹ŸåŒ–ç±»å‹æ£€æµ‹ =====
  local virt_type
  virt_type=""
  if cmd_exists systemd-detect-virt; then
    virt_type="$(systemd-detect-virt 2>/dev/null || true)"
  elif [[ -r /sys/hypervisor/type ]]; then
    virt_type="$(cat /sys/hypervisor/type 2>/dev/null || true)"
  elif grep -qi "docker\|lxc" /proc/1/cgroup 2>/dev/null; then
    virt_type="container"
  fi
  
  if [[ -n "$virt_type" && "$virt_type" != "none" ]]; then
    case "$virt_type" in
      kvm)       info "è™šæ‹ŸåŒ–ç±»å‹ï¼šKVMï¼ˆæ”¯æŒè‡ªå®šä¹‰å†…æ ¸ï¼‰" ;;
      qemu)      info "è™šæ‹ŸåŒ–ç±»å‹ï¼šQEMUï¼ˆæ”¯æŒè‡ªå®šä¹‰å†…æ ¸ï¼‰" ;;
      xen)       info "è™šæ‹ŸåŒ–ç±»å‹ï¼šXenï¼ˆæ”¯æŒè‡ªå®šä¹‰å†…æ ¸ï¼‰" ;;
      vmware)    info "è™šæ‹ŸåŒ–ç±»å‹ï¼šVMwareï¼ˆæ”¯æŒè‡ªå®šä¹‰å†…æ ¸ï¼‰" ;;
      microsoft) info "è™šæ‹ŸåŒ–ç±»å‹ï¼šHyper-Vï¼ˆæ”¯æŒè‡ªå®šä¹‰å†…æ ¸ï¼‰" ;;
      openvz)    warn "è™šæ‹ŸåŒ–ç±»å‹ï¼šOpenVZï¼ˆâš ï¸ æ— æ³•æ›´æ¢å†…æ ¸ï¼‰" ;;
      lxc|lxc-libvirt) warn "è™šæ‹ŸåŒ–ç±»å‹ï¼šLXC å®¹å™¨ï¼ˆâš ï¸ æ— æ³•æ›´æ¢å†…æ ¸ï¼‰" ;;
      container|docker) warn "è™šæ‹ŸåŒ–ç±»å‹ï¼šå®¹å™¨ç¯å¢ƒï¼ˆâš ï¸ æ— æ³•æ›´æ¢å†…æ ¸ï¼‰" ;;
      *) info "è™šæ‹ŸåŒ–ç±»å‹ï¼š$virt_type" ;;
    esac
  else
    info "è™šæ‹ŸåŒ–ç±»å‹ï¼šç‰©ç†æœºæˆ–æœªæ£€æµ‹åˆ°"
  fi

  # ===== CPU æ€§èƒ½æ£€æµ‹ =====
  local cpu_model cpu_cores
  cpu_model="$(grep -m1 'model name' /proc/cpuinfo 2>/dev/null | cut -d: -f2 | xargs || echo unknown)"
  cpu_cores="$(nproc 2>/dev/null || echo 1)"
  info "CPUï¼š$cpu_modelï¼ˆ${cpu_cores}æ ¸ï¼‰"
  
  # AES-NI æŒ‡ä»¤é›†æ£€æµ‹ï¼ˆåŠ å¯†æ€§èƒ½å…³é”®ï¼‰
  if grep -qw aes /proc/cpuinfo 2>/dev/null; then
    ok "AES-NIï¼šå·²æ”¯æŒï¼ˆåŠ å¯†æ€§èƒ½ä¼˜ç§€ï¼‰"
  else
    warn "AES-NIï¼šæœªæ£€æµ‹åˆ°ï¼ˆåŠ å¯†æ€§èƒ½å¯èƒ½è¾ƒä½ï¼Œå»ºè®®ä½¿ç”¨ ChaCha20ï¼‰"
  fi

  # ===== ç½‘å¡æ£€æµ‹ =====
  local nic speed driver ethtool_speed bw_hint
  nic="$(ip route show default 2>/dev/null | awk '/default/ {print $5; exit}')"
  if [[ -n "${nic:-}" ]]; then
    info "é»˜è®¤ç½‘å¡ï¼š$nic"
    
    # è·å–é©±åŠ¨ç±»å‹
    driver=""
    if [[ -r "/sys/class/net/$nic/device/driver" ]]; then
      driver="$(basename "$(readlink -f "/sys/class/net/$nic/device/driver")" 2>/dev/null || true)"
    elif [[ -r "/sys/class/net/$nic/device/uevent" ]]; then
      driver="$(awk -F= '/^DRIVER=/{print $2}' "/sys/class/net/$nic/device/uevent" 2>/dev/null || true)"
    fi
    
    # å°è¯•ä» /sys è¯»å–é€Ÿåº¦
    speed=""
    if [[ -r "/sys/class/net/$nic/speed" ]]; then
      speed="$(cat "/sys/class/net/$nic/speed" 2>/dev/null || true)"
    fi
    
    # å¦‚æœ /sys è¿”å› -1ï¼Œå°è¯• ethtool
    ethtool_speed=""
    if [[ "$speed" == "-1" || -z "$speed" ]] && cmd_exists ethtool; then
      ethtool_speed="$(ethtool "$nic" 2>/dev/null | awk '/Speed:/ {print $2}' || true)"
      if [[ -n "$ethtool_speed" && "$ethtool_speed" != "Unknown!" ]]; then
        speed="$ethtool_speed"
      fi
    fi
    
    # æ ¹æ®é©±åŠ¨ç±»å‹æ¨æ–­å¸¦å®½
    bw_hint=""
    case "${driver:-unknown}" in
      virtio_net|virtio-pci)
        bw_hint="10Gbps+ï¼ˆKVM/QEMU è™šæ‹ŸåŒ–ï¼Œå®é™…å–å†³äºä¸»æœºå•†é™åˆ¶ï¼‰"
        ;;
      xen_netfront)
        bw_hint="å–å†³äºå®ä¾‹ç±»å‹ï¼ˆXen/AWS EC2 æ—§å®ä¾‹ï¼‰"
        ;;
      ena)
        bw_hint="æœ€é«˜ 100Gbpsï¼ˆAWS ENA å¢å¼ºç½‘ç»œï¼‰"
        ;;
      hv_netvsc)
        bw_hint="å–å†³äºå®ä¾‹ç±»å‹ï¼ˆHyper-V/Azureï¼‰"
        ;;
      vmxnet3)
        bw_hint="10Gbpsï¼ˆVMware è™šæ‹ŸåŒ–ï¼‰"
        ;;
      veth)
        bw_hint="å®¹å™¨ç½‘ç»œï¼ˆDocker/LXCï¼‰ï¼Œå¸¦å®½ç”±ä¸»æœºå†³å®š"
        ;;
      *)
        bw_hint=""
        ;;
    esac
    
    # è¾“å‡ºæ£€æµ‹ç»“æœ
    if [[ -n "$driver" ]]; then
      info "ç½‘å¡é©±åŠ¨ï¼š$driver"
    fi
    
    if [[ -n "$speed" && "$speed" != "-1" && "$speed" != "Unknown!" ]]; then
      info "ç½‘å¡é€Ÿç‡ï¼š${speed}Mbps"
    elif [[ -n "$bw_hint" ]]; then
      info "æ¨æµ‹å¸¦å®½ä¸Šé™ï¼š$bw_hint"
      echo -e "  ${YELLOW}ğŸ’¡ å»ºè®®ï¼šé€‰æ‹©ã€ŒVPS æè‡´å¸¦å®½ç‰ˆï¼ˆè™šæ‹Ÿç½‘å¡ï¼‰ã€æ–¹æ¡ˆä»¥æœ€å¤§åŒ–åˆ©ç”¨å¸¦å®½${NC}"
    else
      info "ç½‘å¡é€Ÿç‡ï¼šè™šæ‹Ÿç½‘å¡ï¼ˆæ— æ³•æ£€æµ‹ç‰©ç†é“¾è·¯é€Ÿåº¦ï¼‰"
    fi
  fi

  # ===== UDP ç«¯å£æ£€æµ‹ =====
  line
  info "æ­£åœ¨æ£€æµ‹ UDP è¿é€šæ€§..."
  local udp_test_result
  # æ£€æŸ¥æ˜¯å¦æœ‰ UDP ç›¸å…³çš„ iptables è§„åˆ™é˜»æ­¢
  if cmd_exists iptables; then
    local udp_drop_rules
    udp_drop_rules="$(iptables -L -n 2>/dev/null | grep -i "udp.*drop\|drop.*udp" | head -3 || true)"
    if [[ -n "$udp_drop_rules" ]]; then
      warn "æ£€æµ‹åˆ° UDP ä¸¢å¼ƒè§„åˆ™ï¼ˆå¯èƒ½å½±å“ Hysteria2 ç­‰ UDP ä»£ç†ï¼‰ï¼š"
      echo "$udp_drop_rules" | head -3
    else
      ok "æœªæ£€æµ‹åˆ° UDP é˜»æ­¢è§„åˆ™"
    fi
  fi

  # ===== ç«¯å£é™é€Ÿæ£€æµ‹ï¼ˆtc qdiscï¼‰ =====
  if cmd_exists tc && [[ -n "${nic:-}" ]]; then
    local tc_rules
    tc_rules="$(tc qdisc show dev "$nic" 2>/dev/null || true)"
    if echo "$tc_rules" | grep -qiE "tbf|htb|cake|police"; then
      warn "æ£€æµ‹åˆ°æµé‡æ•´å½¢è§„åˆ™ï¼ˆå¯èƒ½å­˜åœ¨ç«¯å£é™é€Ÿï¼‰ï¼š"
      echo "$tc_rules" | grep -iE "tbf|htb|cake|police" | head -3
    else
      ok "æœªæ£€æµ‹åˆ°ç«¯å£é™é€Ÿè§„åˆ™"
    fi
  fi

  line
  [[ -w /etc/sysctl.d ]] || { err "/etc/sysctl.d ä¸å¯å†™"; return 1; }
  sysctl -a >/dev/null 2>&1 || { err "sysctl è¯»å–å¤±è´¥"; return 1; }

  ok "é¢„æ£€æŸ¥é€šè¿‡"
  return 0
}

conflict_check(){
  echo
  echo -e "${BOLD}ã€å†²çªæ£€æµ‹ã€‘sysctl é‡å¤é”®${NC}"
  line
  local files=()
  [[ -f /etc/sysctl.conf ]] && files+=(/etc/sysctl.conf)
  while IFS= read -r -d '' f; do files+=("$f"); done < <(find /etc/sysctl.d -maxdepth 1 -type f -name "*.conf" -print0 2>/dev/null | sort -z)
  [[ ${#files[@]} -eq 0 ]] && { warn "æœªæ‰¾åˆ°é…ç½®æ–‡ä»¶"; return 0; }

  local out
  out="$(
    awk '
      function trim(s){gsub(/^[ \t]+|[ \t]+$/,"",s); return s}
      {
        line=$0; sub(/#.*/,"",line)
        if (line ~ /^[ \t]*$/ || line !~ /=/) next
        split(line,a,"="); key=trim(a[1]); if(key=="") next
        kf=key SUBSEP FILENAME
        if (!(kf in seen)) { seen[kf]=1; cnt[key]++; files[key]=files[key]?files[key] "," FILENAME:FILENAME }
      }
      END{ for(k in cnt) if(cnt[k]>1) print k " => " files[k] }
    ' "${files[@]}" | sort
  )"

  if [[ -z "$out" ]]; then
    ok "æœªå‘ç°é‡å¤é”®å†²çª"
  else
    warn "å‘ç°é‡å¤é”®ï¼š"
    echo "$out"
    echo
    read -rp "æ˜¯å¦å°è¯•è‡ªåŠ¨ä¿®å¤ï¼ˆæ³¨é‡Šæ‰éç®¡ç†æ–‡ä»¶ä¸­çš„å†—ä½™é¡¹ï¼‰ï¼Ÿ[y/N]: " yn
    if [[ "${yn:-N}" =~ ^[Yy]$ ]]; then
      resolve_conflicts "$out"
    fi
  fi
  line
}

resolve_conflicts(){
  local conflict_out="$1"
  [[ -z "$conflict_out" ]] && return 0

  local hdir
  hdir="$(save_last_and_history_snapshot)"
  info "ä¿®å¤å‰å¿«ç…§ï¼š$hdir"

  info "æ­£åœ¨å‡†å¤‡ä¿®å¤å†²çª..."
  local key file_list f
  while IFS= read -r row; do
    [[ -z "$row" ]] && continue
    key="${row%% => *}"
    file_list="${row#* => }"
    
    IFS=',' read -ra file_array <<< "$file_list"
    for f in "${file_array[@]}"; do
      # æ’é™¤è„šæœ¬ç®¡ç†çš„æ–‡ä»¶
      if [[ "$f" == "$ACTIVE_FILE" || "$f" == "$BBR_SYSCTL_FILE" ]]; then
        continue
      fi
      
      # å…¨é‡è½¬ä¹‰æ­£åˆ™ç‰¹æ®Šå­—ç¬¦
      local escaped_key
      escaped_key="$(escape_regex "$key")"

      if grep -qiE "^[[:space:]]*${escaped_key}[[:space:]]*=" "$f"; then
        if ! grep -q "commented by net-tune-pro repair" "$f"; then
          info "åœ¨ $f ä¸­æ³¨é‡Šæ‰å†²çªé”®ï¼š$key"
          sed -i -E "s/^([[:space:]]*${escaped_key}[[:space:]]*=.*)$/# \1 # commented by net-tune-pro repair/" "$f"
        fi
      fi
    done
  done <<< "$conflict_out"
  
  ok "è‡ªåŠ¨ä¿®å¤å°è¯•å®Œæˆã€‚å»ºè®®å†æ¬¡è¿è¡Œå†²çªæ£€æµ‹ã€‚"
}

# ===================== å¿«ç…§/å›æ»š/æ°¸ä¹…åŸºçº¿ =====================
save_last_and_history_snapshot(){
  local stamp hdir
  stamp="$(ts)"
  rm -rf "${LAST_APPLY_DIR:?}/"* 2>/dev/null || true
  mkdir -p "$LAST_APPLY_DIR/sysctl.d"
  hdir="${HISTORY_DIR}/${stamp}"
  mkdir -p "$hdir/sysctl.d"

  [[ -f /etc/sysctl.conf ]] && cp -a /etc/sysctl.conf "$LAST_APPLY_DIR/sysctl.conf" || true
  [[ -f /etc/sysctl.conf ]] && cp -a /etc/sysctl.conf "$hdir/sysctl.conf" || true
  cp -a /etc/sysctl.d/*.conf "$LAST_APPLY_DIR/sysctl.d/" 2>/dev/null || true
  cp -a /etc/sysctl.d/*.conf "$hdir/sysctl.d/" 2>/dev/null || true

  [[ -f "$ACTIVE_FILE" ]] && cp -a "$ACTIVE_FILE" "$LAST_APPLY_DIR/managed-active.conf" || true
  [[ -f "$ACTIVE_FILE" ]] && cp -a "$ACTIVE_FILE" "$hdir/managed-active.conf" || true
  [[ -f "$BBR_SYSCTL_FILE" ]] && cp -a "$BBR_SYSCTL_FILE" "$LAST_APPLY_DIR/managed-bbr.conf" || true
  [[ -f "$BBR_SYSCTL_FILE" ]] && cp -a "$BBR_SYSCTL_FILE" "$hdir/managed-bbr.conf" || true
  [[ -f "$MODULES_CONF" ]] && cp -a "$MODULES_CONF" "$LAST_APPLY_DIR/managed-modules.conf" || true
  [[ -f "$MODULES_CONF" ]] && cp -a "$MODULES_CONF" "$hdir/managed-modules.conf" || true

  sysctl -a 2>/dev/null > "$LAST_APPLY_DIR/runtime-sysctl-all.txt" || true
  sysctl -a 2>/dev/null > "$hdir/runtime-sysctl-all.txt" || true
  echo "$hdir"
}

clean_old_snapshots(){
  local keep_count="${1:-20}"
  local snapshots count to_delete
  snapshots=($(ls -1d "${HISTORY_DIR}/"* 2>/dev/null | sort))
  count=${#snapshots[@]}
  
  if (( count <= keep_count )); then
    info "å½“å‰å¿«ç…§æ•°é‡ï¼š$countï¼ˆä¿ç•™é˜ˆå€¼ï¼š$keep_countï¼‰ï¼Œæ— éœ€æ¸…ç†"
    return 0
  fi
  
  to_delete=$((count - keep_count))
  info "å°†æ¸…ç† $to_delete ä¸ªæ—§å¿«ç…§ï¼Œä¿ç•™æœ€è¿‘ $keep_count ä¸ª"
  
  for ((i=0; i<to_delete; i++)); do
    rm -rf "${snapshots[$i]}"
    info "å·²åˆ é™¤ï¼š${snapshots[$i]}"
  done
  
  ok "æ¸…ç†å®Œæˆï¼Œå½“å‰å‰©ä½™ï¼š$keep_count ä¸ªå¿«ç…§"
}

rollback_last_apply_point(){
  if [[ -f "$LAST_APPLY_DIR/managed-active.conf" ]]; then
    cp -a "$LAST_APPLY_DIR/managed-active.conf" "$ACTIVE_FILE"
  else
    rm -f "$ACTIVE_FILE"
  fi
  if [[ -f "$LAST_APPLY_DIR/managed-bbr.conf" ]]; then
    cp -a "$LAST_APPLY_DIR/managed-bbr.conf" "$BBR_SYSCTL_FILE"
  fi
  if [[ -f "$LAST_APPLY_DIR/managed-modules.conf" ]]; then
    cp -a "$LAST_APPLY_DIR/managed-modules.conf" "$MODULES_CONF"
  fi

  if sysctl --system >/tmp/net-tune-v3-rollback.log 2>&1; then
    ok "å·²å›æ»šåˆ°ä¸Šä¸€æ¬¡åº”ç”¨ç‚¹ï¼ˆä»…ç®¡ç†æ–‡ä»¶ï¼‰"
  else
    err "å›æ»šå¤±è´¥ï¼Œæ—¥å¿—ï¼š/tmp/net-tune-v3-rollback.log"
    return 1
  fi
}

save_permanent_baseline(){
  local marker="${PERM_DIR}/BASELINE_LOCK"
  [[ -f "$marker" ]] && { warn "æ°¸ä¹…åˆå§‹å¤‡ä»½å·²å­˜åœ¨ï¼š$PERM_DIR"; return 0; }

  mkdir -p "$PERM_DIR/sysctl.d"
  [[ -f /etc/sysctl.conf ]] && cp -a /etc/sysctl.conf "$PERM_DIR/sysctl.conf" || true
  cp -a /etc/sysctl.d/*.conf "$PERM_DIR/sysctl.d/" 2>/dev/null || true
  [[ -f "$ACTIVE_FILE" ]] && cp -a "$ACTIVE_FILE" "$PERM_DIR/managed-active.conf" || true
  [[ -f "$BBR_SYSCTL_FILE" ]] && cp -a "$BBR_SYSCTL_FILE" "$PERM_DIR/managed-bbr.conf" || true
  [[ -f "$MODULES_CONF" ]] && cp -a "$MODULES_CONF" "$PERM_DIR/managed-modules.conf" || true

  # æ³¨æ„ï¼šheredoc æœªåŠ å¼•å·ï¼Œå˜é‡ä¼šåœ¨å†™å…¥æ—¶å±•å¼€ï¼ˆè®°å½•åˆ›å»ºæ—¶ä¿¡æ¯ï¼‰
  cat > "$marker" <<LOCK
CreatedAt=$(date '+%F %T')
Host=$(hostname)
Kernel=$(uname -r)
Note=Permanent baseline, do not overwrite automatically.
LOCK
  chmod 700 "$PERM_DIR" || true
  chmod 600 "$marker" || true
  ok "æ°¸ä¹…åˆå§‹å¤‡ä»½åˆ›å»ºå®Œæˆï¼š$PERM_DIR"

  if cmd_exists chattr; then
    read -rp "æ˜¯å¦ç»™ BASELINE_LOCK æ·»åŠ ä¸å¯å˜å±æ€§ï¼ˆchattr +iï¼‰ï¼Ÿ[y/N]: " yn
    if [[ "${yn:-N}" =~ ^[Yy]$ ]]; then
      if chattr +i "$marker" 2>/dev/null; then
        ok "å·²åŠ é”"
      else
        warn "chattr +i å¤±è´¥ï¼ˆæ–‡ä»¶ç³»ç»Ÿå¯èƒ½ä¸æ”¯æŒï¼‰"
      fi
    fi
  fi
}

restore_permanent_baseline(){
  local marker="${PERM_DIR}/BASELINE_LOCK"
  [[ -f "$marker" ]] || { err "æœªæ‰¾åˆ°æ°¸ä¹…åˆå§‹å¤‡ä»½"; return 1; }

  save_last_and_history_snapshot >/dev/null || true
  if [[ -f "$PERM_DIR/managed-active.conf" ]]; then
    cp -a "$PERM_DIR/managed-active.conf" "$ACTIVE_FILE"
  else
    rm -f "$ACTIVE_FILE"
  fi
  if [[ -f "$PERM_DIR/managed-bbr.conf" ]]; then
    cp -a "$PERM_DIR/managed-bbr.conf" "$BBR_SYSCTL_FILE"
  fi
  if [[ -f "$PERM_DIR/managed-modules.conf" ]]; then
    cp -a "$PERM_DIR/managed-modules.conf" "$MODULES_CONF"
  fi

  if sysctl --system >/tmp/net-tune-v3-restore-baseline.log 2>&1; then
    ok "å·²å›æ»šåˆ°æ°¸ä¹…åˆå§‹é…ç½®ï¼ˆç®¡ç†æ–‡ä»¶èŒƒå›´ï¼‰"
  else
    err "å›æ»šå¤±è´¥ï¼Œæ—¥å¿—ï¼š/tmp/net-tune-v3-restore-baseline.log"
    return 1
  fi
}

# ===================== ç½‘ç»œæ–¹æ¡ˆåº”ç”¨ï¼ˆåŸå­å†™å…¥ï¼‰ =====================
render_profile_to_tmp(){
  local p="$1" tmp="$2"
  { common_base; emit_profile "$p"; } > "$tmp"
}

apply_profile(){
  local p="$1" tmp hdir
  tmp="$(mktemp /tmp/net-tune-v3.XXXXXX.conf)"
  render_profile_to_tmp "$p" "$tmp" || { rm -f "$tmp"; err "æœªçŸ¥æ–¹æ¡ˆ"; return 1; }
  validate_profile_semantics "$tmp" || { rm -f "$tmp"; return 1; }

  hdir="$(save_last_and_history_snapshot)"
  info "å¿«ç…§å·²ä¿å­˜ï¼š$hdir"

  install -m 0644 "$tmp" "${ACTIVE_FILE}.new"
  mv -f "${ACTIVE_FILE}.new" "$ACTIVE_FILE"
  rm -f "$tmp"

  if ! sysctl -p "$ACTIVE_FILE" >/tmp/net-tune-v3-apply-single.log 2>&1; then
    err "å•æ–‡ä»¶æ ¡éªŒå¤±è´¥ï¼š/tmp/net-tune-v3-apply-single.log"
    rollback_last_apply_point >/dev/null 2>&1 || true
    return 1
  fi
  if ! sysctl --system >/tmp/net-tune-v3-apply.log 2>&1; then
    err "å…¨é‡åŠ è½½å¤±è´¥ï¼ˆå¯èƒ½å¤–éƒ¨å†²çªï¼‰ï¼š/tmp/net-tune-v3-apply.log"
    rollback_last_apply_point >/dev/null 2>&1 || true
    return 1
  fi

  CURRENT_PROFILE="$p"
  ok "æ–¹æ¡ˆå·²åº”ç”¨ï¼š$p"
  log "APPLY profile=$p success"
}

# ===================== BBR åŠŸèƒ½ï¼ˆä¸­æ–‡ï¼‰ =====================
clean_bbr_sysctl_conf(){
  touch "$BBR_SYSCTL_FILE"
  sed -i '/^[[:space:]]*net\.core\.default_qdisc[[:space:]]*=/d' "$BBR_SYSCTL_FILE"
  sed -i '/^[[:space:]]*net\.ipv4\.tcp_congestion_control[[:space:]]*=/d' "$BBR_SYSCTL_FILE"
}

load_qdisc_module(){
  local qdisc_name="$1"
  local module_name="sch_$qdisc_name"
  local current_qdisc
  current_qdisc="$(sysctl -n net.core.default_qdisc 2>/dev/null || echo fq_codel)"

  if sysctl -w net.core.default_qdisc="$qdisc_name" >/dev/null 2>&1; then
    sysctl -w net.core.default_qdisc="$current_qdisc" >/dev/null 2>&1 || true
    return 0
  fi

  if lsmod | grep -q "^${module_name//-/_}"; then
    return 0
  fi

  info "å°è¯•åŠ è½½æ¨¡å—ï¼š$module_name"
  if modprobe "$module_name" 2>/dev/null; then
    ok "æ¨¡å—åŠ è½½æˆåŠŸï¼š$module_name"
    return 0
  else
    warn "æ¨¡å—åŠ è½½å¤±è´¥ï¼Œå†…æ ¸å¯èƒ½ä¸æ”¯æŒï¼š$module_name"
    return 1
  fi
}

bbr_qdisc_apply(){
  local algo="$1" qdisc="$2"
  save_last_and_history_snapshot >/dev/null || true

  load_qdisc_module "$qdisc" || true
  sysctl -w net.core.default_qdisc="$qdisc" >/dev/null 2>&1 || true
  sysctl -w net.ipv4.tcp_congestion_control="$algo" >/dev/null 2>&1 || true

  local new_qdisc new_algo
  new_qdisc="$(sysctl -n net.core.default_qdisc 2>/dev/null || echo unknown)"
  new_algo="$(sysctl -n net.ipv4.tcp_congestion_control 2>/dev/null || echo unknown)"

  if [[ "$new_qdisc" == "$qdisc" && "$new_algo" == "$algo" ]]; then
    ok "å·²ç«‹å³ç”Ÿæ•ˆï¼šé˜Ÿåˆ—=$new_qdiscï¼Œæ‹¥å¡æ§åˆ¶=$new_algo"
  else
    err "åº”ç”¨å¤±è´¥ï¼šæœŸæœ› $qdisc/$algoï¼Œå®é™… $new_qdisc/$new_algo"
    return 1
  fi

  read -rp "æ˜¯å¦æ°¸ä¹…ä¿å­˜åˆ° $BBR_SYSCTL_FILE ï¼Ÿ[y/N]: " save
  if [[ "${save:-N}" =~ ^[Yy]$ ]]; then
    clean_bbr_sysctl_conf
    echo "net.core.default_qdisc=$qdisc" >> "$BBR_SYSCTL_FILE"
    echo "net.ipv4.tcp_congestion_control=$algo" >> "$BBR_SYSCTL_FILE"
    sysctl --system >/tmp/net-tune-v3-bbr-save.log 2>&1 || true

    if [[ "$qdisc" == "fq" || "$qdisc" == "fq_codel" ]]; then
      rm -f "$MODULES_CONF"
    else
      echo "sch_$qdisc" > "$MODULES_CONF"
    fi
    ok "å·²æ°¸ä¹…ä¿å­˜"
  else
    warn "æœªæ°¸ä¹…ä¿å­˜ï¼Œé‡å¯åå¯èƒ½æ¢å¤"
  fi
}

get_installed_joey_kernel(){
  dpkg -l 2>/dev/null | awk '/linux-image/ && /joeyblog/ {print $2}' | sed 's/linux-image-//' | head -n1
}

update_bootloader(){
  info "æ­£åœ¨æ›´æ–°å¼•å¯¼åŠ è½½å™¨..."
  if cmd_exists update-grub; then
    if update-grub; then ok "update-grub æˆåŠŸ"; return 0; else err "update-grub å¤±è´¥"; return 1; fi
  else
    warn "æœªæ‰¾åˆ° update-grubã€‚ç³»ç»Ÿå¯èƒ½ä½¿ç”¨å…¶ä»–å¼•å¯¼ï¼ˆå¦‚ U-Bootï¼‰ï¼Œè¯·æŒ‰ç³»ç»Ÿæ–‡æ¡£ç¡®è®¤ã€‚"
    return 0
  fi
}

install_packages_from_tmp(){
  ls /tmp/linux-*.deb >/dev/null 2>&1 || { err "æœªæ‰¾åˆ° /tmp/linux-*.deb"; return 1; }

  local installed
  installed="$(dpkg -l 2>/dev/null | awk '/joeyblog/ {print $2}' | tr '\n' ' ')"
  if [[ -n "$installed" ]]; then
    info "æ­£åœ¨å¸è½½æ—§ç‰ˆå†…æ ¸ï¼š$installed"
    apt-get remove --purge -y $installed >/dev/null 2>&1 || true
  fi

  info "æ­£åœ¨å®‰è£…æ–°å†…æ ¸..."
  if dpkg -i /tmp/linux-*.deb && update_bootloader; then
    ok "å†…æ ¸å®‰è£…å®Œæˆ"
    read -rp "æ˜¯å¦ç«‹å³é‡å¯ä»¥åŠ è½½æ–°å†…æ ¸ï¼Ÿ[y/N]: " rb
    if [[ "${rb:-N}" =~ ^[Yy]$ ]]; then
      reboot
    else
      warn "è¯·ç¨åæ‰‹åŠ¨é‡å¯ï¼šsudo reboot"
    fi
  else
    err "å®‰è£…æˆ–å¼•å¯¼æ›´æ–°å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç³»ç»ŸçŠ¶æ€"
    return 1
  fi
}

install_latest_joey_kernel(){
  is_debian_like || { err "è¯¥åŠŸèƒ½ä»…æ”¯æŒ Debian/Ubuntuï¼ˆapt-getï¼‰"; return 1; }
  ensure_bbr_deps_debian || return 1
  [[ "$ARCH" == "aarch64" || "$ARCH" == "x86_64" ]] || { err "ä»…æ”¯æŒ aarch64/x86_64ï¼Œå½“å‰ï¼š$ARCH"; return 1; }

  local api="https://api.github.com/repos/byJoey/Actions-bbr-v3/releases"
  local data arch_filter latest_tag core_latest installed urls

  info "æ­£åœ¨ä» GitHub è·å–å‘å¸ƒä¿¡æ¯..."
  data="$(curl -fsSL "$api" || true)"
  [[ -n "$data" ]] || { err "è·å–å‘å¸ƒä¿¡æ¯å¤±è´¥"; return 1; }

  arch_filter="x86_64"; [[ "$ARCH" == "aarch64" ]] && arch_filter="arm64"
  latest_tag="$(echo "$data" | jq -r --arg f "$arch_filter" 'map(select(.tag_name|test($f;"i")))|sort_by(.published_at)|.[-1].tag_name')"
  [[ -n "$latest_tag" && "$latest_tag" != "null" ]] || { err "æœªæ‰¾åˆ°åŒ¹é…å½“å‰æ¶æ„çš„ç‰ˆæœ¬"; return 1; }

  installed="$(get_installed_joey_kernel)"
  core_latest="${latest_tag#x86_64-}"; core_latest="${core_latest#arm64-}"
  info "æœ€æ–°ç‰ˆæœ¬ï¼š$latest_tag"
  info "å½“å‰å·²å®‰è£…ï¼š${installed:-æœªå®‰è£…}"

  if [[ -n "$installed" && "$installed" == "$core_latest"* ]]; then
    ok "å½“å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬"
    return 0
  fi

  urls="$(echo "$data" | jq -r --arg t "$latest_tag" '.[]|select(.tag_name==$t)|.assets[].browser_download_url')"
  rm -f /tmp/linux-*.deb
  while IFS= read -r u; do
    [[ -z "$u" ]] && continue
    info "æ­£åœ¨ä¸‹è½½ï¼š$u"
    wget -q --show-progress "$u" -P /tmp/ || { err "ä¸‹è½½å¤±è´¥ï¼š$u"; return 1; }
  done <<< "$urls"

  install_packages_from_tmp
}

install_specific_joey_kernel(){
  is_debian_like || { err "è¯¥åŠŸèƒ½ä»…æ”¯æŒ Debian/Ubuntu"; return 1; }
  ensure_bbr_deps_debian || return 1
  [[ "$ARCH" == "aarch64" || "$ARCH" == "x86_64" ]] || { err "ä»…æ”¯æŒ aarch64/x86_64"; return 1; }

  local api="https://api.github.com/repos/byJoey/Actions-bbr-v3/releases"
  local data arch_filter selected idx urls
  local -a tags

  data="$(curl -fsSL "$api" || true)"
  [[ -n "$data" ]] || { err "è·å–å‘å¸ƒä¿¡æ¯å¤±è´¥"; return 1; }

  arch_filter="x86_64"; [[ "$ARCH" == "aarch64" ]] && arch_filter="arm64"
  mapfile -t tags < <(echo "$data" | jq -r --arg f "$arch_filter" '.[]|select(.tag_name|test($f;"i"))|.tag_name')
  [[ ${#tags[@]} -gt 0 ]] || { err "æœªæ‰¾åˆ°å¯ç”¨ç‰ˆæœ¬"; return 1; }

  echo "å¯é€‰ç‰ˆæœ¬åˆ—è¡¨ï¼š"
  for i in "${!tags[@]}"; do
    echo " $((i+1))) ${tags[$i]}"
  done
  read -rp "è¯·è¾“å…¥è¦å®‰è£…çš„ç‰ˆæœ¬ç¼–å·ï¼š " idx
  [[ "$idx" =~ ^[0-9]+$ ]] || { err "è¾“å…¥æ— æ•ˆ"; return 1; }
  (( idx>=1 && idx<=${#tags[@]} )) || { err "ç¼–å·è¶…å‡ºèŒƒå›´"; return 1; }

  selected="${tags[$((idx-1))]}"
  info "å·²é€‰æ‹©ç‰ˆæœ¬ï¼š$selected"

  urls="$(echo "$data" | jq -r --arg t "$selected" '.[]|select(.tag_name==$t)|.assets[].browser_download_url')"
  rm -f /tmp/linux-*.deb
  while IFS= read -r u; do
    [[ -z "$u" ]] && continue
    info "æ­£åœ¨ä¸‹è½½ï¼š$u"
    wget -q --show-progress "$u" -P /tmp/ || { err "ä¸‹è½½å¤±è´¥ï¼š$u"; return 1; }
  done <<< "$urls"

  install_packages_from_tmp
}

check_bbr_v3_status(){
  local info_mod version algo qdisc
  info_mod="$(modinfo tcp_bbr 2>/dev/null || true)"
  if [[ -z "$info_mod" ]]; then
    warn "æœªæ£€æµ‹åˆ° tcp_bbr æ¨¡å—ä¿¡æ¯ï¼ˆå¯èƒ½æœªåŠ è½½æˆ–å†…æ ¸ä¸åŒ…å«ï¼‰"
  else
    version="$(awk '/^version:/ {print $2}' <<< "$info_mod" | head -n1)"
    [[ -n "$version" ]] && info "tcp_bbr æ¨¡å— versionï¼š$version" || info "æ£€æµ‹åˆ° tcp_bbr æ¨¡å—ï¼ˆæœªè¯»åˆ° version å­—æ®µï¼‰"
  fi

  algo="$(sysctl -n net.ipv4.tcp_congestion_control 2>/dev/null || echo unknown)"
  qdisc="$(sysctl -n net.core.default_qdisc 2>/dev/null || echo unknown)"
  echo "å½“å‰æ‹¥å¡æ§åˆ¶ï¼š$algo"
  echo "å½“å‰é˜Ÿåˆ—ç®—æ³•ï¼š$qdisc"

  if [[ "$algo" == "bbr" ]]; then ok "BBR å·²å¯ç”¨"; else warn "å½“å‰æœªå¯ç”¨ bbr"; fi
}

uninstall_joey_kernel(){
  is_debian_like || { err "è¯¥åŠŸèƒ½ä»…æ”¯æŒ Debian/Ubuntu"; return 1; }
  local pkgs
  pkgs="$(dpkg -l 2>/dev/null | awk '/joeyblog/ {print $2}' | tr '\n' ' ')"
  if [[ -z "$pkgs" ]]; then
    warn "æœªæ‰¾åˆ° joeyblog å†…æ ¸åŒ…"
    return 0
  fi

  info "å°†å¸è½½ä»¥ä¸‹å†…æ ¸åŒ…ï¼š$pkgs"
  apt-get remove --purge -y $pkgs || { err "å¸è½½å¤±è´¥"; return 1; }
  update_bootloader || true
  ok "å¸è½½å®Œæˆï¼Œè¯·é‡å¯ç³»ç»Ÿ"
}

# ===================== çŠ¶æ€/ç›‘æ§ =====================
show_status(){
  echo
  echo -e "${BOLD}ã€å½“å‰çŠ¶æ€ã€‘${NC}"
  line
  echo "ç½‘ç»œæ–¹æ¡ˆæ‰˜ç®¡æ–‡ä»¶ï¼š$ACTIVE_FILE"
  echo "BBRæ‰˜ç®¡æ–‡ä»¶     ï¼š$BBR_SYSCTL_FILE"
  echo "æ¨¡å—é…ç½®æ–‡ä»¶    ï¼š$MODULES_CONF"
  echo "å½“å‰ä¼šè¯æ–¹æ¡ˆ    ï¼š${CURRENT_PROFILE:-unknown}"
  line
  [[ -f "$ACTIVE_FILE" ]] && { echo "[ç½‘ç»œæ–¹æ¡ˆæ–‡ä»¶å†…å®¹]"; cat "$ACTIVE_FILE"; line; }
  [[ -f "$BBR_SYSCTL_FILE" ]] && { echo "[BBRæ–‡ä»¶å†…å®¹]"; cat "$BBR_SYSCTL_FILE"; line; }

  sysctl \
    net.core.default_qdisc \
    net.ipv4.tcp_congestion_control \
    net.core.netdev_max_backlog \
    net.core.somaxconn \
    net.ipv4.tcp_max_syn_backlog \
    net.core.rmem_max \
    net.core.wmem_max \
    net.ipv4.tcp_rmem \
    net.ipv4.tcp_wmem 2>/dev/null || true
}

watch_metrics(){
  info "å®æ—¶ç›‘æ§ä¸­ï¼ˆCtrl+C è¿”å›ï¼‰"
  sleep 1
  while true; do
    clear
    echo -e "${BOLD}===== $(date '+%F %T') =====${NC}"
    echo "[softnet_stat ä¸¢åŒ…åˆ—ï¼ˆç¬¬2åˆ—ï¼‰å‰8è¡Œ]"
    awk '{print NR ": " $2}' /proc/net/softnet_stat | head -n 8
    echo
    echo "[ss -s]"
    ss -s || true
    echo
    nic="$(ip route show default 2>/dev/null | awk '/default/ {print $5; exit}')"
    echo "[é»˜è®¤ç½‘å¡ç»Ÿè®¡: ${nic:-unknown}]"
    [[ -n "${nic:-}" ]] && ip -s link show "$nic" || ip -s link | sed -n '1,40p'
    echo
    echo "[å†…å­˜]"
    free -h || true
    sleep 2
  done
}

# ===================== Virtio/KVM ç½‘å¡ä¼˜åŒ– =====================
apply_virtio_optimizations(){
  echo
  echo -e "${BOLD}ã€Virtio/KVM ç½‘å¡ä¼˜åŒ–ã€‘${NC}"
  line

  local nic driver
  nic="$(ip route show default 2>/dev/null | awk '/default/ {print $5; exit}')"
  if [[ -z "${nic:-}" ]]; then
    err "æœªæ£€æµ‹åˆ°é»˜è®¤ç½‘å¡"
    return 1
  fi
  info "é»˜è®¤ç½‘å¡ï¼š$nic"

  # æ£€æµ‹é©±åŠ¨ç±»å‹
  driver=""
  if [[ -r "/sys/class/net/$nic/device/driver" ]]; then
    driver="$(basename "$(readlink -f "/sys/class/net/$nic/device/driver")" 2>/dev/null || true)"
  elif [[ -r "/sys/class/net/$nic/device/uevent" ]]; then
    driver="$(awk -F= '/^DRIVER=/{print $2}' "/sys/class/net/$nic/device/uevent" 2>/dev/null || true)"
  fi
  info "ç½‘å¡é©±åŠ¨ï¼š${driver:-unknown}"

  if [[ "${driver:-}" != "virtio_net" && "${driver:-}" != "virtio-pci" ]]; then
    warn "å½“å‰ç½‘å¡é©±åŠ¨ä¸æ˜¯ virtio_netï¼Œéƒ¨åˆ†ä¼˜åŒ–å¯èƒ½ä¸é€‚ç”¨"
    read -rp "æ˜¯å¦ç»§ç»­ï¼Ÿ[y/N]: " yn
    if [[ ! "${yn:-N}" =~ ^[Yy]$ ]]; then
      return 0
    fi
  fi

  local cpu_count
  cpu_count="$(nproc 2>/dev/null || echo 1)"
  info "CPU æ ¸å¿ƒæ•°ï¼š$cpu_count"

  # è‡ªåŠ¨å®‰è£… ethtoolï¼ˆå¤šæ•°ä¼˜åŒ–ä¾èµ–å®ƒï¼‰
  if ! cmd_exists ethtool; then
    warn "æœªæ£€æµ‹åˆ° ethtoolï¼Œæ­£åœ¨å°è¯•è‡ªåŠ¨å®‰è£…..."
    if is_debian_like; then
      apt-get update -y >/dev/null 2>&1 || true
      apt-get install -y ethtool >/dev/null 2>&1 && ok "ethtool å®‰è£…æˆåŠŸ" || warn "ethtool å®‰è£…å¤±è´¥ï¼Œéƒ¨åˆ†ä¼˜åŒ–å°†è·³è¿‡"
    elif cmd_exists yum; then
      yum install -y ethtool >/dev/null 2>&1 && ok "ethtool å®‰è£…æˆåŠŸ" || warn "ethtool å®‰è£…å¤±è´¥ï¼Œéƒ¨åˆ†ä¼˜åŒ–å°†è·³è¿‡"
    else
      warn "æ— æ³•è‡ªåŠ¨å®‰è£… ethtoolï¼Œè¯·æ‰‹åŠ¨å®‰è£…ï¼šapt install ethtool æˆ– yum install ethtool"
    fi
  fi

  line

  # ===== 1. Virtio å¤šé˜Ÿåˆ— (Multiqueue) =====
  echo -e "${BOLD}[1/5] Virtio å¤šé˜Ÿåˆ—${NC}"
  if cmd_exists ethtool; then
    local max_combined current_combined
    max_combined="$(ethtool -l "$nic" 2>/dev/null | awk '/Combined:/{v=$2} END{print v}')"
    current_combined="$(ethtool -l "$nic" 2>/dev/null | awk '/Combined:/{print $2; exit}')"
    if [[ -n "$max_combined" && "$max_combined" -gt 1 ]] 2>/dev/null; then
      local target=$((cpu_count < max_combined ? cpu_count : max_combined))
      if ethtool -L "$nic" combined "$target" 2>/dev/null; then
        ok "å¤šé˜Ÿåˆ—å·²è®¾ç½®ä¸º $targetï¼ˆæœ€å¤§ $max_combinedï¼‰"
      else
        warn "å¤šé˜Ÿåˆ—è®¾ç½®å¤±è´¥ï¼ˆå½“å‰ï¼š${current_combined:-unknown}ï¼‰"
      fi
    else
      info "ç½‘å¡ä¸æ”¯æŒå¤šé˜Ÿåˆ—æˆ–å·²æ˜¯å•é˜Ÿåˆ—"
    fi
  else
    warn "æœªå®‰è£… ethtoolï¼Œè·³è¿‡å¤šé˜Ÿåˆ—è®¾ç½®"
  fi

  # ===== 2. RPS / RFSï¼ˆè½¯ä»¶çº§å¤šæ ¸åˆ†å‘ï¼‰ =====
  echo -e "${BOLD}[2/5] RPS / RFS å¤šæ ¸åˆ†å‘${NC}"
  local rps_mask
  rps_mask="$(printf '%x' $(( (1 << cpu_count) - 1 )))"

  local rps_applied=0
  local queue_dir
  for queue_dir in /sys/class/net/"$nic"/queues/rx-*; do
    [[ -d "$queue_dir" ]] || continue
    if echo "$rps_mask" > "$queue_dir/rps_cpus" 2>/dev/null; then
      rps_applied=$((rps_applied + 1))
    fi
    if [[ -w "$queue_dir/rps_flow_cnt" ]]; then
      echo 4096 > "$queue_dir/rps_flow_cnt" 2>/dev/null || true
    fi
  done

  if [[ -w /proc/sys/net/core/rps_sock_flow_entries ]]; then
    echo 32768 > /proc/sys/net/core/rps_sock_flow_entries 2>/dev/null || true
  fi

  if (( rps_applied > 0 )); then
    ok "RPS å·²åº”ç”¨åˆ° $rps_applied ä¸ªæ¥æ”¶é˜Ÿåˆ—ï¼ˆæ©ç ï¼š$rps_maskï¼‰"
    ok "RFS å·²å¯ç”¨ï¼ˆflow_entries=32768ï¼Œflow_cnt=4096ï¼‰"
  else
    warn "RPS è®¾ç½®å¤±è´¥ï¼ˆå¯èƒ½æ— æƒé™ï¼‰"
  fi

  # ===== 3. ç½‘å¡ Ring Buffer åŠ å¤§ =====
  echo -e "${BOLD}[3/5] Ring Buffer${NC}"
  if cmd_exists ethtool; then
    local max_rx max_tx
    max_rx="$(ethtool -g "$nic" 2>/dev/null | awk '/^Pre-set/,/^Current/{if(/RX:/){print $2}}' | head -1)"
    max_tx="$(ethtool -g "$nic" 2>/dev/null | awk '/^Pre-set/,/^Current/{if(/TX:/){print $2}}' | head -1)"
    if [[ -n "$max_rx" && -n "$max_tx" ]]; then
      if ethtool -G "$nic" rx "$max_rx" tx "$max_tx" 2>/dev/null; then
        ok "Ring Buffer å·²è®¾ä¸ºæœ€å¤§å€¼ï¼ˆRX=$max_rx TX=$max_txï¼‰"
      else
        info "Ring Buffer è®¾ç½®å¤±è´¥æˆ–å·²æ˜¯æœ€å¤§å€¼"
      fi
    else
      info "Ring Buffer ä¿¡æ¯è¯»å–å¤±è´¥ï¼Œè·³è¿‡"
    fi
  else
    warn "æœªå®‰è£… ethtoolï¼Œè·³è¿‡ Ring Buffer è®¾ç½®"
  fi

  # ===== 4. ç¡¬ä»¶å¸è½½ï¼ˆGSO/GRO/TSOï¼‰ =====
  echo -e "${BOLD}[4/5] ç¡¬ä»¶å¸è½½æ£€æŸ¥${NC}"
  if cmd_exists ethtool; then
    for feat in gso gro tso; do
      # ethtool -k è¾“å‡ºçš„æ˜¯é•¿åç§°ï¼Œéœ€è¦æ˜ å°„
      local long_feat=""
      case "$feat" in
        gso) long_feat="generic-segmentation-offload" ;;
        gro) long_feat="generic-receive-offload" ;;
        tso) long_feat="tcp-segmentation-offload" ;;
      esac

      local status
      # ä½¿ç”¨ awk æå–çŠ¶æ€ï¼Œé¿å… grep æ‰¾ä¸åˆ°æ—¶è¿”å› 1 å¯¼è‡´è„šæœ¬é€€å‡º (set -e)
      status="$(ethtool -k "$nic" 2>/dev/null | awk -v f="$long_feat" '$1 == f":" {print $2}')"
      
      if [[ "$status" == "off" ]]; then
        if ethtool -K "$nic" "$feat" on 2>/dev/null; then
          ok "$feat å·²å¼€å¯"
        else
          warn "$feat å¼€å¯å¤±è´¥ï¼ˆå¯èƒ½ä¸æ”¯æŒï¼‰"
        fi
      else
        ok "$feat å·²æ˜¯å¼€å¯çŠ¶æ€"
      fi
    done
  else
    warn "æœªå®‰è£… ethtoolï¼Œè·³è¿‡ç¡¬ä»¶å¸è½½æ£€æŸ¥"
  fi

  # ===== 5. ä¸­æ–­åˆå¹¶ï¼ˆå‡å°‘ CPU å¼€é”€ï¼‰ =====
  echo -e "${BOLD}[5/5] ä¸­æ–­åˆå¹¶${NC}"
  if cmd_exists ethtool; then
    if ethtool -C "$nic" adaptive-rx on adaptive-tx on 2>/dev/null; then
      ok "è‡ªé€‚åº”ä¸­æ–­åˆå¹¶å·²å¼€å¯"
    else
      info "è‡ªé€‚åº”ä¸­æ–­åˆå¹¶è®¾ç½®å¤±è´¥ï¼ˆvirtio å¯èƒ½ä¸æ”¯æŒï¼Œè¿™æ˜¯æ­£å¸¸çš„ï¼‰"
    fi
  else
    warn "æœªå®‰è£… ethtoolï¼Œè·³è¿‡ä¸­æ–­åˆå¹¶è®¾ç½®"
  fi

  line
  ok "Virtio/KVM ç½‘å¡ä¼˜åŒ–å®Œæˆ"
  warn "æ³¨æ„ï¼šä»¥ä¸Šè®¾ç½®é‡å¯åå¤±æ•ˆï¼Œå»ºè®®æ·»åŠ åˆ° /etc/rc.local æˆ– systemd æœåŠ¡ä¸­æŒä¹…åŒ–"
  log "VIRTIO_OPTIMIZE nic=$nic driver=${driver:-unknown} cpus=$cpu_count"
}

# ===================== è„šæœ¬æ›´æ–° =====================
update_script(){
  echo
  echo -e "${BOLD}ã€è„šæœ¬æ›´æ–°ã€‘${NC}"
  line
  info "å½“å‰ç‰ˆæœ¬ï¼š$VERSION"
  info "æ­£åœ¨æ£€æŸ¥æ–°ç‰ˆæœ¬..."

  local update_url="https://raw.githubusercontent.com/suxayii/Throttle/master/install.sh"
  local tmp_file="/tmp/net-tune-pro-update.sh"

  if cmd_exists curl; then
    curl -fsSL "$update_url" -o "$tmp_file"
  elif cmd_exists wget; then
    wget -qO "$tmp_file" "$update_url"
  else
    err "æœªæ‰¾åˆ° curl æˆ– wgetï¼Œæ— æ³•ä¸‹è½½æ›´æ–°"
    return 1
  fi

  if [[ ! -s "$tmp_file" ]]; then
    err "ä¸‹è½½å¤±è´¥æˆ–æ–‡ä»¶ä¸ºç©ºï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥"
    rm -f "$tmp_file"
    return 1
  fi

  # ç®€å•çš„å†…å®¹æ¯”å¯¹
  if cmp -s "$0" "$tmp_file"; then
    ok "å½“å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬"
    rm -f "$tmp_file"
    return 0
  else
    # å°è¯•æå–æ–°ç‰ˆæœ¬å·ï¼ˆå¦‚æœè„šæœ¬é‡Œæœ‰å®šä¹‰ VERSIONï¼‰
    local new_ver
    new_ver="$(grep '^VERSION=' "$tmp_file" | head -1 | cut -d'"' -f2)"
    [[ -z "$new_ver" ]] && new_ver="æœªçŸ¥"
    
    info "å‘ç°æ–°ç‰ˆæœ¬ï¼š$new_ver"
    read -rp "æ˜¯å¦æ›´æ–°è„šæœ¬ï¼Ÿ[y/N]: " yn
    if [[ "${yn:-N}" =~ ^[Yy]$ ]]; then
      mv "$tmp_file" "$0"
      chmod +x "$0"
      ok "è„šæœ¬æ›´æ–°æˆåŠŸï¼Œå³å°†é‡æ–°åŠ è½½..."
      sleep 2
      exec bash "$0"
    else
      info "å·²å–æ¶ˆæ›´æ–°"
      rm -f "$tmp_file"
    fi
  fi
}

# ===================== èœå• =====================
choose_profile_menu(){
  local p p_name
  while true; do
    clear
    echo -e "${BOLD}ã€é€‰æ‹©å¹¶åº”ç”¨ç½‘ç»œä¼˜åŒ–æ–¹æ¡ˆã€‘${NC}"
    line
    echo "1) å¹³è¡¡ç‰ˆï¼ˆé€šç”¨æ¨èï¼‰"
    echo "2) æ¿€è¿›ç‰ˆï¼ˆé«˜å¹¶å‘/é«˜PPSï¼‰"
    echo "3) æ¿€è¿›ç¨³å¦¥ç‰ˆï¼ˆæ¨èï¼‰"
    echo "4) UDP ä¸“é¡¹ç‰ˆï¼ˆQUIC/UDP ä¼˜åŒ–ï¼‰"
    echo "5) æµåª’ä½“ä»£ç†ç‰ˆï¼ˆVLESS/Reality TCPï¼‰"
    echo "6) ä½å†…å­˜ä¿å®ˆç‰ˆï¼ˆ1C/1Gï¼‰"
    echo "7) ä½å†…å­˜ä¿å®ˆç‰ˆï¼ˆ2C/2Gï¼‰"
    echo "8) é«˜å¸¦å®½ç‰ˆï¼ˆ1Gå£ï¼‰"
    echo "9) é«˜å¸¦å®½ç‰ˆï¼ˆ10Gå£ï¼‰"
    echo "10) VPS æè‡´å¸¦å®½ç‰ˆï¼ˆè™šæ‹Ÿç½‘å¡ï¼‰"
    echo "0) è¿”å›"
    line
    read -rp "è¯·è¾“å…¥é€‰é¡¹ [0-10]: " c

    case "$c" in
      1) p="balanced"; p_name="å¹³è¡¡ç‰ˆï¼ˆé€šç”¨æ¨èï¼‰" ;;
      2) p="aggressive"; p_name="æ¿€è¿›ç‰ˆï¼ˆé«˜å¹¶å‘/é«˜PPSï¼‰" ;;
      3) p="aggressive_safe"; p_name="æ¿€è¿›ç¨³å¦¥ç‰ˆï¼ˆæ¨èï¼‰" ;;
      4) p="udp_quic"; p_name="UDP ä¸“é¡¹ç‰ˆï¼ˆQUIC/UDP ä¼˜åŒ–ï¼‰" ;;
      5) p="streaming"; p_name="æµåª’ä½“ä»£ç†ç‰ˆï¼ˆVLESS/Reality TCPï¼‰" ;;
      6) p="low_1c1g"; p_name="ä½å†…å­˜ä¿å®ˆç‰ˆï¼ˆ1C/1Gï¼‰" ;;
      7) p="low_2c2g"; p_name="ä½å†…å­˜ä¿å®ˆç‰ˆï¼ˆ2C/2Gï¼‰" ;;
      8) p="bw_1g"; p_name="é«˜å¸¦å®½ç‰ˆï¼ˆ1Gå£ï¼‰" ;;
      9) p="bw_10g"; p_name="é«˜å¸¦å®½ç‰ˆï¼ˆ10Gå£ï¼‰" ;;
      10) p="vps_max"; p_name="VPS æè‡´å¸¦å®½ç‰ˆï¼ˆè™šæ‹Ÿç½‘å¡ï¼‰" ;;
      0) return ;;
      *) warn "æ— æ•ˆè¾“å…¥"; sleep 1; continue ;;
    esac

    precheck || { pause; continue; }
    conflict_check
    read -rp "ç¡®è®¤åº”ç”¨ã€Œ$p_nameã€å—ï¼Ÿ[y/N]: " yn
    if [[ "${yn:-N}" =~ ^[Yy]$ ]]; then
      apply_profile "$p" && ok "å·²åº”ç”¨ï¼š$p_name"
    else
      warn "å·²å–æ¶ˆ"
    fi
    pause
    return
  done
}

bbr_menu(){
  while true; do
    clear
    echo -e "${BOLD}ã€BBR å†…æ ¸ä¸é˜Ÿåˆ—ç®¡ç†ã€‘${NC}"
    line
    echo "1) å®‰è£…/æ›´æ–° BBR v3ï¼ˆæœ€æ–°ç‰ˆï¼‰"
    echo "2) å®‰è£…æŒ‡å®šç‰ˆæœ¬ BBR å†…æ ¸"
    echo "3) æ£€æŸ¥ BBR v3 çŠ¶æ€"
    echo "4) å¯ç”¨ BBR + FQ"
    echo "5) å¯ç”¨ BBR + FQ_CODEL"
    echo "6) å¯ç”¨ BBR + FQ_PIE"
    echo "7) å¯ç”¨ BBR + CAKE"
    echo "8) å¸è½½ joeyblog å†…æ ¸"
    echo "0) è¿”å›"
    line
    read -rp "è¯·è¾“å…¥é€‰é¡¹ [0-8]: " a
    case "$a" in
      1) install_latest_joey_kernel ;;
      2) install_specific_joey_kernel ;;
      3) check_bbr_v3_status ;;
      4) bbr_qdisc_apply "bbr" "fq" ;;
      5) bbr_qdisc_apply "bbr" "fq_codel" ;;
      6) bbr_qdisc_apply "bbr" "fq_pie" ;;
      7) bbr_qdisc_apply "bbr" "cake" ;;
      8) uninstall_joey_kernel ;;
      0) return ;;
      *) warn "æ— æ•ˆè¾“å…¥" ;;
    esac
    pause
  done
}

main_menu(){
  while true; do
    clear
    echo -e "${BOLD}${BLUE}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘   Net Tune Pro v3 ä¸­æ–‡ç‰ˆï¼ˆç½‘ç»œä¼˜åŒ– + BBR å…¨åŠŸèƒ½ï¼‰      â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
    echo "1) é¢„æ£€æŸ¥é˜¶æ®µ"
    echo "2) å†²çªæ£€æµ‹ï¼ˆsysctl é‡å¤é”®ï¼‰"
    echo "3) åº”ç”¨ç½‘ç»œä¼˜åŒ–æ–¹æ¡ˆï¼ˆåŸå­å†™å…¥ï¼‰"
    echo "4) BBR å†…æ ¸/é˜Ÿåˆ—ç®¡ç†ï¼ˆå®‰è£…/å‡çº§/å¸è½½/å¯ç”¨ï¼‰"
    echo "5) æŸ¥çœ‹å½“å‰çŠ¶æ€"
    echo "6) å®æ—¶ç›‘æ§"
    echo "7) å›æ»šåˆ°ä¸Šä¸€æ¬¡åº”ç”¨ç‚¹"
    echo "8) åˆ›å»ºæ°¸ä¹…åˆå§‹å¤‡ä»½ï¼ˆä»…é¦–æ¬¡ï¼‰"
    echo "9) å›æ»šåˆ°æ°¸ä¹…åˆå§‹é…ç½®ï¼ˆç®¡ç†æ–‡ä»¶èŒƒå›´ï¼‰"
    echo "10) æŸ¥çœ‹å†å²å¿«ç…§åˆ—è¡¨"
    echo "11) æ¸…ç†æ—§å¿«ç…§ï¼ˆä¿ç•™æœ€è¿‘20ä¸ªï¼‰"
    echo "12) Virtio/KVM ç½‘å¡ä¼˜åŒ–"
    echo "13) æ›´æ–°è„šæœ¬"
    echo "0) é€€å‡º"
    line
    read -rp "è¯·è¾“å…¥é€‰é¡¹: " ch
    case "$ch" in
      1) precheck; pause ;;
      2) conflict_check; pause ;;
      3) choose_profile_menu ;;
      4) bbr_menu ;;
      5) show_status; pause ;;
      6) watch_metrics ;;
      7) rollback_last_apply_point; pause ;;
      8) save_permanent_baseline; pause ;;
      9)
        read -rp "ç¡®è®¤å›æ»šåˆ°æ°¸ä¹…åˆå§‹é…ç½®ï¼Ÿ[y/N]: " yn
        if [[ "${yn:-N}" =~ ^[Yy]$ ]]; then
          restore_permanent_baseline
        else
          warn "å·²å–æ¶ˆ"
        fi
        pause
        ;;
      10) ls -1 "$HISTORY_DIR" 2>/dev/null | sort || true; pause ;;
      11) clean_old_snapshots 20; pause ;;
      12) apply_virtio_optimizations; pause ;;
      13) update_script; pause ;;
      0) ok "å·²é€€å‡º"; exit 0 ;;
      *) warn "æ— æ•ˆè¾“å…¥"; sleep 1 ;;
    esac
  done
}

need_root
check_base_deps
main_menu
EOF

chmod +x /root/net-tune-pro-v3-zh.sh
bash /root/net-tune-pro-v3-zh.sh
